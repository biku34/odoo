<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rewear Admin Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom CSS for Odoo-like purple theme and animations */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for overflow areas */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* For horizontal scrollbars */
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #a78bfa; /* Light purple */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #8b5cf6; /* Darker purple on hover */
        }

        /* Custom animations */
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }

        @keyframes scale-in {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .animate-scale-in {
            animation: scale-in 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* Sidebar item active state */
        .sidebar-item.active {
            background-color: #6d28d9; /* Deeper purple for active */
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .sidebar-item:hover:not(.active) {
            background-color: #8b5cf6; /* Lighter purple on hover */
            color: white;
        }

        /* Table header sort indicator */
        .sortable-header {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .sortable-header:hover {
            background-color: #ede9fe; /* Even lighter purple on hover */
        }

        /* Modal specific styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
        }
        .modal-content {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        /* Form elements focus */
        input:focus, select:focus, textarea:focus {
            border-color: #7c3aed !important;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.3) !important;
        }

        /* Button styles */
        .btn-primary {
            background-color: #7c3aed;
            color: white;
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-primary:hover {
            background-color: #6d28d9;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
            transform: translateY(-1px);
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        .btn-outline-purple {
            border: 1px solid #7c3aed;
            color: #7c3aed;
            background-color: transparent;
            transition: background-color 0.2s, color 0.2s;
        }
        .btn-outline-purple:hover {
            background-color: #7c3aed;
            color: white;
        }

        /* Tag styling in Item form */
        .tag-checkbox-label {
            transition: background-color 0.2s, border-color 0.2s;
        }
        .tag-checkbox-label:has(input:checked) {
            background-color: #ede9fe;
            border-color: #7c3aed;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-purple-800 text-white flex flex-col shadow-xl">
            <div class="p-6 text-2xl font-bold border-b border-purple-700 flex items-center gap-2">
                <i data-lucide="settings" class="text-purple-300 w-7 h-7"></i>
                Rewear Admin
            </div>
            <nav class="flex-grow p-4 space-y-2">
                <button class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors duration-200 active" data-tab="users">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span class="text-lg font-medium">Users</span>
                </button>
                <button class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors duration-200" data-tab="items">
                    <i data-lucide="package" class="w-5 h-5"></i>
                    <span class="text-lg font-medium">Items</span>
                </button>
                <button class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors duration-200" data-tab="swaps">
                    <i data-lucide="repeat" class="w-5 h-5"></i>
                    <span class="text-lg font-medium">Swaps</span>
                </button>
                <button class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors duration-200" data-tab="redemptions">
                    <i data-lucide="dollar-sign" class="w-5 h-5"></i>
                    <span class="text-lg font-medium">Redemptions</span>
                </button>
                <button class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors duration-200" data-tab="tags">
                    <i data-lucide="tag" class="w-5 h-5"></i>
                    <span class="text-lg font-medium">Tags</span>
                </button>
            </nav>
            <div class="p-6 text-sm text-purple-300 border-t border-purple-700">
                Â© 2024 Rewear. All rights reserved.
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 p-8 overflow-auto">
            <!-- Content will be dynamically loaded here by JavaScript -->
        </main>
    </div>

    <!-- Modals -->

    <!-- Generic Modal Structure (for all forms) -->
    <div id="genericModal" class="modal-overlay fixed inset-0 hidden items-center justify-center z-50 p-4 animate-fade-in">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 relative w-full max-h-[90vh] overflow-y-auto transform scale-95 animate-scale-in">
            <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-4">
                <h3 id="modalTitle" class="text-2xl font-semibold text-gray-800"></h3>
                <button id="modalCloseBtn" class="text-gray-500 hover:text-gray-700 transition-colors duration-200" aria-label="Close modal">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modalBody">
                <!-- Form content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay fixed inset-0 hidden items-center justify-center z-50 p-4 animate-fade-in">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 relative w-full max-w-sm max-h-[90vh] overflow-y-auto transform scale-95 animate-scale-in">
            <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">Confirm Action</h3>
                <button class="text-gray-500 hover:text-gray-700 transition-colors duration-200" aria-label="Close modal" onclick="closeModal('confirmationModal')">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="text-center py-4">
                <i data-lucide="alert-circle" class="text-red-500 mx-auto mb-4 w-12 h-12"></i>
                <p id="confirmMessage" class="text-gray-700 text-lg mb-6"></p>
                <div class="flex justify-center gap-4">
                    <button class="px-6 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors duration-200" onclick="closeModal('confirmationModal')">
                        Cancel
                    </button>
                    <button id="confirmActionButton" class="px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors duration-200">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box Modal -->
    <div id="messageBoxModal" class="modal-overlay fixed inset-0 hidden items-center justify-center z-50 p-4 animate-fade-in">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 relative w-full max-w-sm max-h-[90vh] overflow-y-auto transform scale-95 animate-scale-in">
            <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-4">
                <h3 id="messageBoxTitle" class="text-2xl font-semibold text-gray-800"></h3>
                <button class="text-gray-500 hover:text-gray-700 transition-colors duration-200" aria-label="Close modal" onclick="closeModal('messageBoxModal')">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="text-center py-4">
                <div id="messageBoxIcon" class="mx-auto mb-4"></div>
                <p id="messageBoxText" class="text-gray-700 text-lg mb-6"></p>
                <button class="px-6 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition-colors duration-200" onclick="closeModal('messageBoxModal')">
                    OK
                </button>
            </div>
        </div>
    </div>


    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // --- Mock Data ---
        let mockUsers = [
            { id: 1, name: 'Admin User', email: 'admin@rewear.com', password_hash: 'hashedpass1', profile_image: 'https://placehold.co/50x50/7c3aed/ffffff?text=AD', points_balance: 1000, is_admin: true, created_at: '2024-01-15T10:00:00Z', updated_at: '2024-07-10T12:00:00Z' },
            { id: 2, name: 'Alice Smith', email: 'alice@example.com', password_hash: 'hashedpass2', profile_image: 'https://placehold.co/50x50/a78bfa/ffffff?text=AS', points_balance: 500, is_admin: false, created_at: '2024-02-20T11:30:00Z', updated_at: '2024-07-09T10:00:00Z' },
            { id: 3, name: 'Bob Johnson', email: 'bob@example.com', password_hash: 'hashedpass3', profile_image: 'https://placehold.co/50x50/c4b5fd/ffffff?text=BJ', points_balance: 750, is_admin: false, created_at: '2024-03-01T09:00:00Z', updated_at: '2024-07-08T14:00:00Z' },
            { id: 4, name: 'Charlie Brown', email: 'charlie@example.com', password_hash: 'hashedpass4', profile_image: 'https://placehold.co/50x50/8b5cf6/ffffff?text=CB', points_balance: 200, is_admin: false, created_at: '2024-04-10T15:00:00Z', updated_at: '2024-07-07T09:00:00Z' },
            { id: 5, name: 'Diana Prince', email: 'diana@example.com', password_hash: 'hashedpass5', profile_image: 'https://placehold.co/50x50/6d28d9/ffffff?text=DP', points_balance: 1200, is_admin: false, created_at: '2024-05-05T13:00:00Z', updated_at: '2024-07-06T11:00:00Z' },
            { id: 6, name: 'Eve Adams', email: 'eve@example.com', password_hash: 'hashedpass6', profile_image: 'https://placehold.co/50x50/5b21b6/ffffff?text=EA', points_balance: 300, is_admin: false, created_at: '2024-06-01T10:00:00Z', updated_at: '2024-07-05T10:00:00Z' },
            { id: 7, name: 'Frank White', email: 'frank@example.com', password_hash: 'hashedpass7', profile_image: 'https://placehold.co/50x50/4c1d95/ffffff?text=FW', points_balance: 900, is_admin: false, created_at: '2024-06-15T14:00:00Z', updated_at: '2024-07-04T13:00:00Z' },
            { id: 8, name: 'Grace Lee', email: 'grace@example.com', password_hash: 'hashedpass8', profile_image: 'https://placehold.co/50x50/3b0764/ffffff?text=GL', points_balance: 600, is_admin: false, created_at: '2024-07-01T09:00:00Z', updated_at: '2024-07-03T09:00:00Z' },
        ];

        let mockItems = [
            { id: 101, user_id: 2, title: 'Vintage Denim Jacket', description: 'Classic blue denim jacket, perfect for all seasons. Lightly worn, great condition.', category: 'Apparel', type: 'Unisex', size: 'M', condition: 'Good', status: 'available', created_at: '2024-07-01T10:00:00Z' },
            { id: 102, user_id: 3, title: 'Leather Crossbody Bag', description: 'Stylish black leather bag with adjustable strap. Minor scuffs, otherwise excellent.', category: 'Accessories', type: 'Women', size: 'One Size', condition: 'Very Good', status: 'available', created_at: '2024-06-28T14:30:00Z' },
            { id: 103, user_id: 2, title: 'Running Shoes', description: 'Comfortable and durable running shoes. Used for a few runs, clean.', category: 'Footwear', type: 'Unisex', size: 'US 9', condition: 'Good', status: 'available', created_at: '2024-06-25T09:15:00Z' },
            { id: 104, user_id: 4, title: 'Silk Scarf', description: 'Elegant silk scarf with floral patterns. No visible flaws.', category: 'Accessories', type: 'Women', size: 'Large', condition: 'Excellent', status: 'available', created_at: '2024-06-20T11:00:00Z' },
            { id: 105, user_id: 5, title: 'Wool Blend Sweater', description: 'Warm and cozy sweater, perfect for winter. Minor pilling.', category: 'Apparel', type: 'Men', size: 'L', condition: 'Good', status: 'available', created_at: '2024-06-18T16:45:00Z' },
            { id: 106, user_id: 6, title: 'Ceramic Coffee Mug Set', description: 'Set of 4 handmade ceramic mugs. Never used.', category: 'Home Goods', type: 'Unisex', size: 'One Size', condition: 'New', status: 'available', created_at: '2024-06-15T08:00:00Z' },
            { id: 107, user_id: 7, title: 'Vintage Leather Boots', description: 'Well-preserved leather boots, classic design. Minor wear on soles.', category: 'Footwear', type: 'Men', size: 'US 8', condition: 'Very Good', status: 'available', created_at: '2024-06-10T13:00:00Z' },
            { id: 108, user_id: 8, title: 'Graphic T-Shirt', description: 'Soft cotton t-shirt with a unique graphic print. Excellent condition.', category: 'Apparel', type: 'Unisex', size: 'M', condition: 'Excellent', status: 'available', created_at: '2024-06-05T10:30:00Z' },
            { id: 109, user_id: 2, title: 'Designer Sunglasses', description: 'Stylish sunglasses with UV protection. Comes with original case.', category: 'Accessories', type: 'Unisex', size: 'One Size', condition: 'Excellent', status: 'available', created_at: '2024-06-01T15:00:00Z' },
            { id: 110, user_id: 3, title: 'Wooden Picture Frame', description: 'Hand-carved wooden frame, fits 5x7 photo. New.', category: 'Home Goods', type: 'Unisex', size: 'One Size', condition: 'New', status: 'available', created_at: '2024-05-28T09:00:00Z' },
        ];

        let mockItemImages = [
            { id: 1, item_id: 101, image_url: 'https://placehold.co/300x200/a78bfa/ffffff?text=Denim+Jacket', is_primary: true },
            { id: 2, item_id: 102, image_url: 'https://placehold.co/300x200/c4b5fd/ffffff?text=Leather+Bag', is_primary: true },
            { id: 3, item_id: 103, image_url: 'https://placehold.co/300x200/8b5cf6/ffffff?text=Running+Shoes', is_primary: true },
            { id: 4, item_id: 104, image_url: 'https://placehold.co/300x200/7c3aed/ffffff?text=Silk+Scarf', is_primary: true },
            { id: 5, item_id: 105, image_url: 'https://placehold.co/300x200/6d28d9/ffffff?text=Wool+Sweater', is_primary: true },
            { id: 6, item_id: 106, image_url: 'https://placehold.co/300x200/5b21b6/ffffff?text=Coffee+Mugs', is_primary: true },
            { id: 7, item_id: 107, image_url: 'https://placehold.co/300x200/4c1d95/ffffff?text=Leather+Boots', is_primary: true },
            { id: 8, item_id: 108, image_url: 'https://placehold.co/300x200/3b0764/ffffff?text=Graphic+Tee', is_primary: true },
            { id: 9, item_id: 109, image_url: 'https://placehold.co/300x200/2e1065/ffffff?text=Sunglasses', is_primary: true },
            { id: 10, item_id: 110, image_url: 'https://placehold.co/300x200/1e074d/ffffff?text=Picture+Frame', is_primary: true },
            { id: 11, item_id: 101, image_url: 'https://placehold.co/300x200/a78bfa/ffffff?text=Denim+Jacket+2', is_primary: false },
            { id: 12, item_id: 101, image_url: 'https://placehold.co/300x200/a78bfa/ffffff?text=Denim+Jacket+3', is_primary: false },
        ];

        let mockTags = [
            { id: 1, name: 'Sustainable' },
            { id: 2, name: 'Vintage' },
            { id: 3, name: 'Handmade' },
            { id: 4, name: 'Eco-friendly' },
            { id: 5, name: 'Unused' },
        ];

        let mockItemTags = [
            { item_id: 101, tag_id: 2 }, // Denim Jacket: Vintage
            { item_id: 101, tag_id: 1 }, // Denim Jacket: Sustainable
            { item_id: 106, tag_id: 3 }, // Coffee Mug Set: Handmade
            { item_id: 106, tag_id: 5 }, // Coffee Mug Set: Unused
            { item_id: 104, tag_id: 2 }, // Silk Scarf: Vintage
            { item_id: 109, tag_id: 5 }, // Designer Sunglasses: Unused
        ];

        let mockSwaps = [
            { id: 1, requester_id: 2, responder_id: 3, requester_item_id: 101, responder_item_id: 102, status: 'pending', created_at: '2024-07-02T10:00:00Z', updated_at: '2024-07-02T10:00:00Z' },
            { id: 2, requester_id: 4, responder_id: 5, requester_item_id: 104, responder_item_id: 105, status: 'accepted', created_at: '2024-07-01T11:00:00Z', updated_at: '2024-07-01T15:00:00Z' },
            { id: 3, requester_id: 6, responder_id: 7, requester_item_id: 106, responder_item_id: 107, status: 'rejected', created_at: '2024-06-29T14:00:00Z', updated_at: '2024-06-30T09:00:00Z' },
            { id: 4, requester_id: 8, responder_id: 2, requester_item_id: 108, responder_item_id: 103, status: 'completed', created_at: '2024-06-25T16:00:00Z', updated_at: '2024-06-26T10:00:00Z' },
        ];

        let mockRedemptions = [
            { id: 1, user_id: 2, item_id: 109, points_used: 150, status: 'approved', created_at: '2024-07-03T09:00:00Z' },
            { id: 2, user_id: 3, item_id: 110, points_used: 100, status: 'pending', created_at: '2024-07-02T11:00:00Z' },
            { id: 3, user_id: 4, item_id: 101, points_used: 200, status: 'rejected', created_at: '2024-06-30T10:00:00Z' },
        ];

        // --- Global State Variables ---
        let activeTab = 'users';
        let currentTableData = [];
        let currentColumns = [];
        let searchTerm = '';
        let sortColumn = null;
        let sortDirection = 'asc';
        let currentPage = 1;
        const itemsPerPage = 10;
        let confirmActionCallback = null; // Callback for confirmation modal

        // --- Utility Functions ---

        function generateId() {
            return Math.floor(Math.random() * 1000000) + Date.now();
        }

        /**
         * Shows a generic modal with dynamic content.
         * @param {string} title - Title of the modal.
         * @param {string} contentHtml - HTML string for the modal body.
         * @param {string} [size='md'] - 'sm', 'md', 'lg', 'xl', '2xl', '3xl', '4xl'.
         */
        function showModal(title, contentHtml, size = 'md') {
            const modal = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalContentDiv = modal.querySelector('.modal-content');

            modalTitle.textContent = title;
            modalBody.innerHTML = contentHtml;

            // Set size class
            const sizeClasses = ['max-w-sm', 'max-w-md', 'max-w-lg', 'max-w-xl', 'max-w-2xl', 'max-w-3xl', 'max-w-4xl'];
            sizeClasses.forEach(cls => modalContentDiv.classList.remove(cls));
            modalContentDiv.classList.add(`max-w-${size}`);

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons(); // Re-render Lucide icons in new content
        }

        /**
         * Closes a specified modal.
         * @param {string} modalId - The ID of the modal to close.
         */
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('flex');
            document.getElementById(modalId).classList.add('hidden');
        }

        /**
         * Shows the confirmation modal.
         * @param {string} message - The message to display.
         * @param {function} onConfirm - Callback function to execute if confirmed.
         */
        function showConfirmation(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmActionButton').onclick = () => {
                onConfirm();
                closeModal('confirmationModal');
            };
            document.getElementById('confirmationModal').classList.remove('hidden');
            document.getElementById('confirmationModal').classList.add('flex');
        }

        /**
         * Shows a custom message box modal.
         * @param {string} title - The title of the message box.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'info'} [type='info'] - Type of message for styling.
         */
        function showMessageBox(title, message, type = 'info') {
            document.getElementById('messageBoxTitle').textContent = title;
            document.getElementById('messageBoxText').textContent = message;
            const iconContainer = document.getElementById('messageBoxIcon');
            iconContainer.innerHTML = ''; // Clear previous icon

            let iconHtml = '';
            let iconColorClass = '';
            if (type === 'success') {
                iconHtml = '<i data-lucide="check" class="w-12 h-12"></i>';
                iconColorClass = 'text-green-500';
            } else if (type === 'error') {
                iconHtml = '<i data-lucide="alert-circle" class="w-12 h-12"></i>';
                iconColorClass = 'text-red-500';
            } else {
                iconHtml = '<i data-lucide="info" class="w-12 h-12"></i>';
                iconColorClass = 'text-blue-500';
            }
            iconContainer.innerHTML = iconHtml;
            iconContainer.className = `mx-auto mb-4 ${iconColorClass}`; // Apply color class
            lucide.createIcons(); // Render the new icon

            document.getElementById('messageBoxModal').classList.remove('hidden');
            document.getElementById('messageBoxModal').classList.add('flex');
        }

        // --- Table View Rendering ---

        /**
         * Renders a generic table with data, search, sort, and pagination.
         * @param {Array<object>} data - The full dataset.
         * @param {Array<object>} columns - Column definitions: [{ key: string, label: string, render?: function, sortable?: boolean }]
         * @param {string} title - Title for the table.
         * @param {function} onAdd - Callback for Add button.
         * @param {function} onEdit - Callback for Edit button.
         * @param {function} onDelete - Callback for Delete button.
         */
        function renderTableView(data, columns, title, onAdd, onEdit, onDelete, extraActions = []) {
            currentTableData = data;
            currentColumns = columns;
            currentPage = 1; // Reset to first page on new table render

            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col h-full">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <h2 class="text-3xl font-bold text-gray-800">${title}</h2>
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <input
                                    type="text"
                                    id="tableSearchInput"
                                    placeholder="Search..."
                                    class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200"
                                    value="${searchTerm}"
                                />
                                <i data-lucide="search" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            ${onAdd ? `
                            <button id="tableAddButton" class="px-5 py-2 bg-purple-600 text-white rounded-lg flex items-center gap-2 hover:bg-purple-700 transition-colors duration-200 shadow-md">
                                <i data-lucide="plus" class="w-5 h-5"></i> Add New
                            </button>` : ''}
                        </div>
                    </div>

                    <div class="overflow-x-auto flex-grow">
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead class="bg-purple-100 border-b border-purple-200">
                                <tr id="tableHeaderRow">
                                    <!-- Headers will be injected here -->
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-gray-200">
                                <!-- Data rows will be injected here -->
                            </tbody>
                        </table>
                    </div>

                    <div id="tablePagination" class="flex justify-between items-center mt-6">
                        <!-- Pagination controls will be injected here -->
                    </div>
                </div>
            `;
            lucide.createIcons(); // Render icons in the new HTML

            // Attach event listeners
            document.getElementById('tableSearchInput').addEventListener('input', (e) => {
                searchTerm = e.target.value;
                currentPage = 1; // Reset page on search
                updateTableDisplay();
            });
            if (onAdd) {
                document.getElementById('tableAddButton').addEventListener('click', onAdd);
            }

            updateTableDisplay(onEdit, onDelete, extraActions);
        }

        function updateTableDisplay(onEditCallback, onDeleteCallback, extraActions = []) {
            const tableHeaderRow = document.getElementById('tableHeaderRow');
            const tableBody = document.getElementById('tableBody');
            const tablePagination = document.getElementById('tablePagination');

            // Render Headers
            tableHeaderRow.innerHTML = '';
            currentColumns.forEach(col => {
                const th = document.createElement('th');
                th.className = `py-3 px-4 text-left text-sm font-semibold text-purple-800 uppercase tracking-wider ${col.sortable ? 'sortable-header' : ''}`;
                th.innerHTML = `
                    <div class="flex items-center">
                        ${col.label}
                        ${col.sortable ? `
                            <span class="ml-1">
                                ${sortColumn === col.key && sortDirection === 'asc' ? '<i data-lucide="chevron-up" class="w-4 h-4"></i>' : ''}
                                ${sortColumn === col.key && sortDirection === 'desc' ? '<i data-lucide="chevron-down" class="w-4 h-4"></i>' : ''}
                                ${sortColumn !== col.key ? '<i data-lucide="chevron-up" class="w-4 h-4 opacity-30"></i>' : ''}
                            </span>
                        ` : ''}
                    </div>
                `;
                if (col.sortable) {
                    th.addEventListener('click', () => handleSort(col.key, onEditCallback, onDeleteCallback, extraActions));
                }
                tableHeaderRow.appendChild(th);
            });

            // Add Actions header if needed
            if (onEditCallback || onDeleteCallback || extraActions.length > 0) {
                const thActions = document.createElement('th');
                thActions.className = "py-3 px-4 text-center text-sm font-semibold text-purple-800 uppercase tracking-wider";
                thActions.textContent = "Actions";
                tableHeaderRow.appendChild(thActions);
            }
            lucide.createIcons(); // Render icons in headers

            // Filter, Sort, and Paginate Data
            let filtered = currentTableData.filter(item =>
                currentColumns.some(col =>
                    item[col.key]?.toString().toLowerCase().includes(searchTerm.toLowerCase())
                )
            );

            if (sortColumn) {
                filtered.sort((a, b) => {
                    const aValue = a[sortColumn];
                    const bValue = b[sortColumn];
                    if (typeof aValue === 'string' && typeof bValue === 'string') {
                        return sortDirection === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                    }
                    if (typeof aValue === 'number' && typeof bValue === 'number') {
                        return sortDirection === 'asc' ? aValue - bValue : bValue - aValue;
                    }
                    return 0;
                });
            }

            const totalPages = Math.ceil(filtered.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedData = filtered.slice(startIndex, startIndex + itemsPerPage);

            // Render Body
            tableBody.innerHTML = '';
            if (paginatedData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${currentColumns.length + (onEditCallback || onDeleteCallback || extraActions.length > 0 ? 1 : 0)}" class="text-center py-8 text-gray-500 text-lg">
                            No data available.
                        </td>
                    </tr>
                `;
            } else {
                paginatedData.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition-colors duration-150";
                    currentColumns.forEach(col => {
                        const td = document.createElement('td');
                        td.className = "py-3 px-4 text-sm text-gray-700";
                        td.innerHTML = col.render ? col.render(row) : (row[col.key]?.toString() || '');
                        tr.appendChild(td);
                    });

                    // Add Actions column
                    if (onEditCallback || onDeleteCallback || extraActions.length > 0) {
                        const tdActions = document.createElement('td');
                        tdActions.className = "py-3 px-4 text-center text-sm";
                        tdActions.innerHTML = `
                            <div class="flex justify-center gap-2">
                                ${onEditCallback ? `<button class="text-blue-600 hover:text-blue-800 transition-colors duration-200 p-1 rounded-full hover:bg-blue-100" title="Edit" data-action="edit"><i data-lucide="edit" class="w-4 h-4"></i></button>` : ''}
                                ${onDeleteCallback ? `<button class="text-red-600 hover:text-red-800 transition-colors duration-200 p-1 rounded-full hover:bg-red-100" title="Delete" data-action="delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                                ${extraActions.map(action => `
                                    <button class="text-gray-600 hover:text-gray-800 transition-colors duration-200 p-1 rounded-full hover:bg-gray-100" title="${action.tooltip}" data-action="${action.name}">
                                        <i data-lucide="${action.icon}" class="w-4 h-4"></i>
                                    </button>
                                `).join('')}
                            </div>
                        `;
                        tr.appendChild(tdActions);

                        // Attach event listeners for action buttons
                        if (onEditCallback) {
                            tdActions.querySelector('[data-action="edit"]').addEventListener('click', () => onEditCallback(row));
                        }
                        if (onDeleteCallback) {
                            tdActions.querySelector('[data-action="delete"]').addEventListener('click', () => showConfirmation(`Are you sure you want to delete this ${title.slice(0, -1).toLowerCase()}?`, () => onDeleteCallback(row)));
                        }
                        extraActions.forEach(action => {
                            tdActions.querySelector(`[data-action="${action.name}"]`).addEventListener('click', () => action.onClick(row));
                        });
                    }
                    tableBody.appendChild(tr);
                });
            }
            lucide.createIcons(); // Render icons in table body

            // Render Pagination
            tablePagination.innerHTML = `
                <button id="prevPageBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-300 transition-colors duration-200" ${currentPage === 1 ? 'disabled' : ''}>
                    Previous
                </button>
                <span class="text-gray-700">
                    Page ${currentPage} of ${totalPages === 0 ? 1 : totalPages}
                </span>
                <button id="nextPageBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-300 transition-colors duration-200" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>
                    Next
                </button>
            `;
            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateTableDisplay(onEditCallback, onDeleteCallback, extraActions);
                }
            });
            document.getElementById('nextPageBtn').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    updateTableDisplay(onEditCallback, onDeleteCallback, extraActions);
                }
            });
        }

        function handleSort(columnKey, onEditCallback, onDeleteCallback, extraActions) {
            if (sortColumn === columnKey) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = columnKey;
                sortDirection = 'asc';
            }
            currentPage = 1; // Reset to first page on sort
            updateTableDisplay(onEditCallback, onDeleteCallback, extraActions);
        }

        // --- User Management ---
        function renderUserManagement() {
            const userColumns = [
                { key: 'id', label: 'ID', sortable: true },
                { key: 'name', label: 'Name', sortable: true },
                { key: 'email', label: 'Email', sortable: true },
                { key: 'points_balance', label: 'Points', sortable: true },
                { key: 'is_admin', label: 'Admin', render: (user) => user.is_admin ? 'Yes' : 'No', sortable: true },
                { key: 'created_at', label: 'Created At', render: (user) => new Date(user.created_at).toLocaleDateString(), sortable: true },
            ];

            renderTableView(mockUsers, userColumns, "Users", showAddEditUserModal, editUser, deleteUser);
        }

        function showAddEditUserModal(user = null) {
            let modalTitle = user ? 'Edit User' : 'Add New User';
            let formData = user ? { ...user } : { name: '', email: '', password_hash: '', profile_image: '', points_balance: 0, is_admin: false };

            const formHtml = `
                <form id="userForm" class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="name" name="name" value="${formData.name}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500"/>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" name="email" value="${formData.email}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500"/>
                    </div>
                    <div>
                        <label for="password_hash" class="block text-sm font-medium text-gray-700">Password (Hashed)</label>
                        <input type="text" id="password_hash" name="password_hash" value="${formData.password_hash}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500"/>
                    </div>
                    <div>
                        <label for="profile_image" class="block text-sm font-medium text-gray-700">Profile Image URL</label>
                        <input type="text" id="profile_image" name="profile_image" value="${formData.profile_image}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500"/>
                    </div>
                    <div>
                        <label for="points_balance" class="block text-sm font-medium text-gray-700">Points Balance</label>
                        <input type="number" id="points_balance" name="points_balance" value="${formData.points_balance}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500"/>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="is_admin" name="is_admin" ${formData.is_admin ? 'checked' : ''} class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"/>
                        <label for="is_admin" class="ml-2 block text-sm text-gray-900">Is Admin</label>
                    </div>
                    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 mt-4">
                        <button type="button" onclick="closeModal('genericModal')" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors duration-200">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition-colors duration-200">Save</button>
                    </div>
                </form>
            `;

            showModal(modalTitle, formHtml);

            document.getElementById('userForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const formElements = e.target.elements;
                const userData = {
                    name: formElements.name.value,
                    email: formElements.email.value,
                    password_hash: formElements.password_hash.value,
                    profile_image: formElements.profile_image.value,
                    points_balance: parseInt(formElements.points_balance.value),
                    is_admin: formElements.is_admin.checked,
                };

                if (user) {
                    // Edit existing user
                    mockUsers = mockUsers.map(u => u.id === user.id ? { ...u, ...userData, updated_at: new Date().toISOString() } : u);
                    showMessageBox('Success', `User "${userData.name}" updated successfully.`, 'success');
                } else {
                    // Add new user
                    const newUser = { ...userData, id: generateId(), created_at: new Date().toISOString(), updated_at: new Date().toISOString() };
                    mockUsers.push(newUser);
                    showMessageBox('Success', `User "${newUser.name}" added successfully.`, 'success');
                }
                closeModal('genericModal');
                renderUserManagement(); // Re-render table
            });
        }

        function editUser(user) {
            showAddEditUserModal(user);
        }

        function deleteUser(userToDelete) {
            mockUsers = mockUsers.filter(user => user.id !== userToDelete.id);
            showMessageBox('Success', `User "${userToDelete.name}" deleted successfully.`, 'success');
            renderUserManagement(); // Re-render table
        }

        // --- Item Management ---
        function renderItemManagement() {
            const itemColumns = [
                { key: 'id', label: 'ID', sortable: true },
                { key: 'title', label: 'Title', sortable: true },
                {
                    key: 'user_id',
                    label: 'Owner',
                    render: (item) => mockUsers.find(u => u.id === item.user_id)?.name || 'N/A',
                    sortable: true
                },
                { key: 'category', label: 'Category', sortable: true },
                { key: 'size', label: 'Size', sortable: true },
                { key: 'condition', label: 'Condition', sortable: true },
                { key: 'status', label: 'Status', sortable: true },
                {
                    key: 'tags',
                    label: 'Tags',
                    render: (item) => {
                        const itemTagNames = mockItemTags
                            .filter(it => it.item_id === item.id)
                            .map(it => mockTags.find(t => t.id === it.tag_id)?.name)
                            .filter(Boolean);
                        return itemTagNames.length > 0 ? itemTagNames.join(', ') : 'None';
                    },
                    sortable: false
                },
                { key: 'created_at', label: 'Created At', render: (item) => new Date(item.created_at).toLocaleDateString(), sortable: true },
                {
                    key: 'primary_image',
                    label: 'Image',
                    render: (item) => {
                        const primaryImage = mockItemImages.find(img => img.item_id === item.id && img.is_primary);
                        return primaryImage ? (
                            `<img src="${primaryImage.image_url}" alt="${item.title}" class="w-12 h-12 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/50x50/e0e0e0/555555?text=NA';"/>`
                        ) : (
                            `<i data-lucide="image" class="w-6 h-6 text-gray-400"></i>`
                        );
                    },
                    sortable: false
                }
            ];

            renderTableView(mockItems, itemColumns, "Items", showAddEditItemModal, editItem, deleteItem);
        }

        function showAddEditItemModal(item = null) {
            let modalTitle = item ? 'Edit Item' : 'Add New Item';
            let formData = item ? { ...item } : { user_id: '', title: '', description: '', category: '', type: '', size: '', condition: '', status: 'available' };
            let currentImages = item ? mockItemImages.filter(img => img.item_id === item.id) : [];
            let selectedTagIds = item ? mockItemTags.filter(it => it.item_id === item.id).map(it => it.tag_id) : [];

            const itemConditions = ['New', 'Like New', 'Very Good', 'Good', 'Fair', 'Poor'];
            const itemStatuses = ['available', 'swapped', 'pending'];
            const itemTypes = ['Men', 'Women', 'Unisex', 'Kids'];
            const itemCategories = ['Apparel', 'Accessories', 'Footwear', 'Home Goods', 'Electronics', 'Books', 'Sports & Outdoors', 'Toys & Games'];
            const itemSizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL', 'One Size', 'US 6', 'US 7', 'US 8', 'US 9', 'US 10', 'US 11', 'US 12'];

            const generateImageInputs = (images) => {
                return images.map((img, index) => `
                    <div class="flex items-center gap-3 p-2 border border-gray-200 rounded-md bg-gray-50">
                        <input
                            type="text"
                            placeholder="Image URL"
                            value="${img.image_url}"
                            oninput="handleImageChange(event, ${img.id}, 'image_url')"
                            class="flex-grow border border-gray-300 rounded-md py-1 px-2 text-sm focus:ring-purple-500 focus:border-purple-500"
                        />
                        <label class="flex items-center gap-1 text-sm text-gray-700">
                            <input
                                type="checkbox"
                                ${img.is_primary ? 'checked' : ''}
                                onchange="handleSetPrimaryImage(event, ${img.id})"
                                class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                            />
                            Primary
                        </label>
                        <button
                            type="button"
                            onclick="handleDeleteImage(event, ${img.id})"
                            class="text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-100"
                            title="Delete Image"
                        >
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `).join('');
            };

            const generateTagCheckboxes = (allTags, selectedTags) => {
                return allTags.map(tag => `
                    <label class="flex items-center gap-2 text-sm text-gray-700 p-2 border border-gray-200 rounded-md cursor-pointer hover:bg-gray-50 tag-checkbox-label">
                        <input
                            type="checkbox"
                            value="${tag.id}"
                            ${selectedTags.includes(tag.id) ? 'checked' : ''}
                            onchange="handleTagChange(event, ${tag.id})"
                            class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                        />
                        ${tag.name}
                    </label>
                `).join('');
            };


            const formHtml = `
                <form id="itemForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="user_id" class="block text-sm font-medium text-gray-700">Owner User</label>
                            <select id="user_id" name="user_id" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500">
                                <option value="">Select User</option>
                                ${mockUsers.map(u => `<option value="${u.id}" ${formData.user_id === u.id ? 'selected' : ''}>${u.name} (ID: ${u.id})</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
                            <input type="text" id="title" name="title" value="${formData.title}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500"/>
                        </div>
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                            <select id="category" name="category" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500">
                                <option value="">Select Category</option>
                                ${itemCategories.map(cat => `<option value="${cat}" ${formData.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="type" class="block text-sm font-medium text-gray-700">Type</label>
                            <select id="type" name="type" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500">
                                <option value="">Select Type</option>
                                ${itemTypes.map(type => `<option value="${type}" ${formData.type === type ? 'selected' : ''}>${type}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="size" class="block text-sm font-medium text-gray-700">Size</label>
                            <select id="size" name="size" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500">
                                <option value="">Select Size</option>
                                ${itemSizes.map(size => `<option value="${size}" ${formData.size === size ? 'selected' : ''}>${size}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="condition" class="block text-sm font-medium text-gray-700">Condition</label>
                            <select id="condition" name="condition" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500">
                                <option value="">Select Condition</option>
                                ${itemConditions.map(cond => `<option value="${cond}" ${formData.condition === cond ? 'selected' : ''}>${cond}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="description" name="description" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500">${formData.description}</textarea>
                        </div>
                        <div>
                            <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="status" name="status" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500">
                                ${itemStatuses.map(status => `<option value="${status}" ${formData.status === status ? 'selected' : ''}>${status}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <!-- Image Management Section -->
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Item Images</h4>
                        <div id="imageInputsContainer" class="space-y-3">
                            ${generateImageInputs(currentImages)}
                        </div>
                        <button type="button" id="addImageButton" class="mt-4 px-4 py-2 border border-purple-600 text-purple-600 rounded-lg flex items-center gap-2 hover:bg-purple-50 transition-colors duration-200">
                            <i data-lucide="image" class="w-4 h-4"></i> Add Image
                        </button>
                    </div>

                    <!-- Tags Management Section -->
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Item Tags</h4>
                        <div id="tagCheckboxesContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                            ${mockTags.length > 0 ? generateTagCheckboxes(mockTags, selectedTagIds) : '<p class="text-sm text-gray-500 col-span-full">No tags available. Add tags in the Tags section.</p>'}
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 mt-4">
                        <button type="button" onclick="closeModal('genericModal')" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors duration-200">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition-colors duration-200">Save</button>
                    </div>
                </form>
            `;

            showModal(modalTitle, formHtml, '3xl'); // Use a larger modal for items

            // Re-attach event listeners for dynamic elements
            document.getElementById('addImageButton').addEventListener('click', () => {
                currentImages.push({ id: generateId(), image_url: '', is_primary: false });
                document.getElementById('imageInputsContainer').innerHTML = generateImageInputs(currentImages);
                lucide.createIcons();
            });

            // Global handlers for image changes and tag changes (delegated)
            window.handleImageChange = (event, imgId, field) => {
                const imgIndex = currentImages.findIndex(img => img.id === imgId);
                if (imgIndex !== -1) {
                    currentImages[imgIndex][field] = event.target.value;
                }
            };
            window.handleDeleteImage = (event, imgId) => {
                event.stopPropagation();
                currentImages = currentImages.filter(img => img.id !== imgId);
                document.getElementById('imageInputsContainer').innerHTML = generateImageInputs(currentImages);
                lucide.createIcons();
            };
            window.handleSetPrimaryImage = (event, imgId) => {
                currentImages = currentImages.map(img => ({
                    ...img,
                    is_primary: img.id === imgId ? event.target.checked : false,
                }));
                document.getElementById('imageInputsContainer').innerHTML = generateImageInputs(currentImages);
                lucide.createIcons();
            };
            window.handleTagChange = (event, tagId) => {
                if (event.target.checked) {
                    selectedTagIds.push(tagId);
                } else {
                    selectedTagIds = selectedTagIds.filter(id => id !== tagId);
                }
            };


            document.getElementById('itemForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const formElements = e.target.elements;
                const itemData = {
                    user_id: parseInt(formElements.user_id.value),
                    title: formElements.title.value,
                    description: formElements.description.value,
                    category: formElements.category.value,
                    type: formElements.type.value,
                    size: formElements.size.value,
                    condition: formElements.condition.value,
                    status: formElements.status.value,
                };

                // Validation for primary image
                if (currentImages.length > 0 && !currentImages.some(img => img.is_primary)) {
                    showMessageBox('Validation Error', 'Please set one image as primary.', 'error');
                    return;
                }

                if (item) {
                    // Edit existing item
                    mockItems = mockItems.map(i => i.id === item.id ? { ...i, ...itemData, updated_at: new Date().toISOString() } : i);
                    // Update images
                    mockItemImages = mockItemImages.filter(img => img.item_id !== item.id); // Remove old images
                    currentImages.forEach(img => mockItemImages.push({ ...img, item_id: item.id })); // Add updated images
                    // Update item_tags
                    mockItemTags = mockItemTags.filter(it => it.item_id !== item.id); // Remove old item_tags
                    selectedTagIds.forEach(tagId => mockItemTags.push({ item_id: item.id, tag_id: tagId })); // Add new item_tags

                    showMessageBox('Success', `Item "${itemData.title}" updated successfully.`, 'success');
                } else {
                    // Add new item
                    const newItem = { ...itemData, id: generateId(), created_at: new Date().toISOString() };
                    mockItems.push(newItem);
                    // Add images for new item
                    currentImages.forEach(img => mockItemImages.push({ ...img, item_id: newItem.id }));
                    // Add item_tags for new item
                    selectedTagIds.forEach(tagId => mockItemTags.push({ item_id: newItem.id, tag_id: tagId }));

                    showMessageBox('Success', `Item "${newItem.title}" added successfully.`, 'success');
                }
                closeModal('genericModal');
                renderItemManagement(); // Re-render table
            });
        }

        function editItem(item) {
            showAddEditItemModal(item);
        }

        function deleteItem(itemToDelete) {
            mockItems = mockItems.filter(item => item.id !== itemToDelete.id);
            mockItemImages = mockItemImages.filter(img => img.item_id !== itemToDelete.id); // Also remove images
            mockItemTags = mockItemTags.filter(it => it.item_id !== itemToDelete.id); // Also remove item_tags
            showMessageBox('Success', `Item "${itemToDelete.title}" deleted successfully.`, 'success');
            renderItemManagement(); // Re-render table
        }

        // --- Swap Management ---
        function renderSwapManagement() {
            const swapColumns = [
                { key: 'id', label: 'ID', sortable: true },
                {
                    key: 'requester_id',
                    label: 'Requester',
                    render: (swap) => mockUsers.find(u => u.id === swap.requester_id)?.name || 'N/A',
                    sortable: true
                },
                {
                    key: 'responder_id',
                    label: 'Responder',
                    render: (swap) => mockUsers.find(u => u.id === swap.responder_id)?.name || 'N/A',
                    sortable: true
                },
                {
                    key: 'requester_item_id',
                    label: 'Requester Item',
                    render: (swap) => mockItems.find(i => i.id === swap.requester_item_id)?.title || 'N/A',
                    sortable: true
                },
                {
                    key: 'responder_item_id',
                    label: 'Responder Item',
                    render: (swap) => mockItems.find(i => i.id === swap.responder_item_id)?.title || 'N/A',
                    sortable: true
                },
                { key: 'status', label: 'Status', sortable: true },
                { key: 'created_at', label: 'Created At', render: (swap) => new Date(swap.created_at).toLocaleDateString(), sortable: true },
            ];

            renderTableView(mockSwaps, swapColumns, "Swaps", null, editSwap, deleteSwap);
        }

        function showEditSwapModal(swap) {
            let modalTitle = `Edit Swap ID: ${swap.id}`;
            let formData = { ...swap };

            const swapStatuses = ['pending', 'accepted', 'rejected', 'completed'];

            const formHtml = `
                <form id="swapForm" class="space-y-4">
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="status" name="status" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500">
                            ${swapStatuses.map(s => `<option value="${s}" ${formData.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 mt-4">
                        <button type="button" onclick="closeModal('genericModal')" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors duration-200">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition-colors duration-200">Save</button>
                    </div>
                </form>
            `;

            showModal(modalTitle, formHtml, 'sm');

            document.getElementById('swapForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const newStatus = e.target.elements.status.value;
                mockSwaps = mockSwaps.map(s => s.id === swap.id ? { ...s, status: newStatus, updated_at: new Date().toISOString() } : s);
                showMessageBox('Success', `Swap ID ${swap.id} status updated to "${newStatus}".`, 'success');
                closeModal('genericModal');
                renderSwapManagement();
            });
        }

        function editSwap(swap) {
            showEditSwapModal(swap);
        }

        function deleteSwap(swapToDelete) {
            mockSwaps = mockSwaps.filter(swap => swap.id !== swapToDelete.id);
            showMessageBox('Success', `Swap ID ${swapToDelete.id} deleted successfully.`, 'success');
            renderSwapManagement();
        }

        // --- Redemption Management ---
        function renderRedemptionManagement() {
            const redemptionColumns = [
                { key: 'id', label: 'ID', sortable: true },
                {
                    key: 'user_id',
                    label: 'User',
                    render: (redemption) => mockUsers.find(u => u.id === redemption.user_id)?.name || 'N/A',
                    sortable: true
                },
                {
                    key: 'item_id',
                    label: 'Item',
                    render: (redemption) => mockItems.find(i => i.id === redemption.item_id)?.title || 'N/A',
                    sortable: true
                },
                { key: 'points_used', label: 'Points Used', sortable: true },
                { key: 'status', label: 'Status', sortable: true },
                { key: 'created_at', label: 'Created At', render: (redemption) => new Date(redemption.created_at).toLocaleDateString(), sortable: true },
            ];

            renderTableView(mockRedemptions, redemptionColumns, "Redemptions", null, editRedemption, deleteRedemption);
        }

        function showEditRedemptionModal(redemption) {
            let modalTitle = `Edit Redemption ID: ${redemption.id}`;
            let formData = { ...redemption };

            const redemptionStatuses = ['pending', 'approved', 'rejected'];

            const formHtml = `
                <form id="redemptionForm" class="space-y-4">
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="status" name="status" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500">
                            ${redemptionStatuses.map(s => `<option value="${s}" ${formData.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 mt-4">
                        <button type="button" onclick="closeModal('genericModal')" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors duration-200">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition-colors duration-200">Save</button>
                    </div>
                </form>
            `;

            showModal(modalTitle, formHtml, 'sm');

            document.getElementById('redemptionForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const newStatus = e.target.elements.status.value;
                mockRedemptions = mockRedemptions.map(r => r.id === redemption.id ? { ...r, status: newStatus } : r);
                showMessageBox('Success', `Redemption ID ${redemption.id} status updated to "${newStatus}".`, 'success');
                closeModal('genericModal');
                renderRedemptionManagement();
            });
        }

        function editRedemption(redemption) {
            showEditRedemptionModal(redemption);
        }

        function deleteRedemption(redemptionToDelete) {
            mockRedemptions = mockRedemptions.filter(redemption => redemption.id !== redemptionToDelete.id);
            showMessageBox('Success', `Redemption ID ${redemptionToDelete.id} deleted successfully.`, 'success');
            renderRedemptionManagement();
        }

        // --- Tag Management ---
        function renderTagManagement() {
            const tagColumns = [
                { key: 'id', label: 'ID', sortable: true },
                { key: 'name', label: 'Name', sortable: true },
            ];

            renderTableView(mockTags, tagColumns, "Tags", showAddEditTagModal, editTag, deleteTag);
        }

        function showAddEditTagModal(tag = null) {
            let modalTitle = tag ? 'Edit Tag' : 'Add New Tag';
            let formData = tag ? { ...tag } : { name: '' };

            const formHtml = `
                <form id="tagForm" class="space-y-4">
                    <div>
                        <label for="tagName" class="block text-sm font-medium text-gray-700">Tag Name</label>
                        <input type="text" id="tagName" name="tagName" value="${formData.name}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-purple-500 focus:border-purple-500"/>
                    </div>
                    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 mt-4">
                        <button type="button" onclick="closeModal('genericModal')" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors duration-200">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition-colors duration-200">Save</button>
                    </div>
                </form>
            `;

            showModal(modalTitle, formHtml, 'sm');

            document.getElementById('tagForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const tagName = e.target.elements.tagName.value.trim();
                if (!tagName) {
                    showMessageBox('Validation Error', 'Tag name cannot be empty.', 'error');
                    return;
                }

                if (tag) {
                    // Edit existing tag
                    mockTags = mockTags.map(t => t.id === tag.id ? { ...t, name: tagName } : t);
                    showMessageBox('Success', `Tag "${tagName}" updated successfully.`, 'success');
                } else {
                    // Add new tag
                    const newTag = { id: generateId(), name: tagName };
                    mockTags.push(newTag);
                    showMessageBox('Success', `Tag "${newTag.name}" added successfully.`, 'success');
                }
                closeModal('genericModal');
                renderTagManagement(); // Re-render table
            });
        }

        function editTag(tag) {
            showAddEditTagModal(tag);
        }

        function deleteTag(tagToDelete) {
            // Check if tag is used by any item before deleting
            const isTagUsed = mockItemTags.some(it => it.tag_id === tagToDelete.id);
            if (isTagUsed) {
                showMessageBox('Error', `Cannot delete tag "${tagToDelete.name}" because it is currently associated with one or more items. Please remove it from items first.`, 'error');
                return;
            }

            mockTags = mockTags.filter(tag => tag.id !== tagToDelete.id);
            showMessageBox('Success', `Tag "${tagToDelete.name}" deleted successfully.`, 'success');
            renderTagManagement(); // Re-render table
        }


        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Sidebar navigation
            document.querySelectorAll('.sidebar-item').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.sidebar-item').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    activeTab = button.dataset.tab;
                    searchTerm = ''; // Reset search term on tab change
                    sortColumn = null; // Reset sort on tab change
                    sortDirection = 'asc'; // Reset sort direction on tab change
                    currentPage = 1; // Reset page on tab change

                    // Render content based on active tab
                    if (activeTab === 'users') {
                        renderUserManagement();
                    } else if (activeTab === 'items') {
                        renderItemManagement();
                    } else if (activeTab === 'swaps') {
                        renderSwapManagement();
                    } else if (activeTab === 'redemptions') {
                        renderRedemptionManagement();
                    } else if (activeTab === 'tags') {
                        renderTagManagement();
                    }
                });
            });

            // Close generic modal when clicking outside content
            document.getElementById('genericModal').addEventListener('click', (event) => {
                if (event.target.id === 'genericModal') {
                    closeModal('genericModal');
                }
            });
            document.getElementById('modalCloseBtn').addEventListener('click', () => closeModal('genericModal'));

            // Initial render of the default tab (Users)
            renderUserManagement();
        });
    </script>
</body>
</html>
